trigger:
  branches:
    include:
      - main

variables:
  ACR_NAME: stevencapstoneacr #
  IMAGE_NAME: frontend-app #
  IMAGE_TAG: $(Build.BuildId) #
  AKS_CLUSTER: aks-capstone-dev #
  RESOURCE_GROUP: steven-rg-capstone-dev #
  NAMESPACE: frontend #

pool:
  vmImage: ubuntu-latest

stages:
- stage: BuildAndDeploy
  displayName: Build & Deploy Frontend
  jobs:
  - job: BuildDeploy
    displayName: Docker Build → ACR → AKS
    steps:

    # Azure login (unavoidable helper)
    - task: AzureCLI@2
      displayName: Azure Login
      inputs:
        azureSubscription: stevens-capstone-dev-conn
        scriptType: bash
        scriptLocation: inlineScript
        inlineScript: |
          az account show

    # Docker build & push (SCRIPT-BASED)
    - script: |
        set -e
        echo "Logging into ACR..."
        az acr login --name $ACR_NAME

        echo "Building Docker image..."
        docker build \
          -t $ACR_NAME.azurecr.io/$IMAGE_NAME:$IMAGE_TAG \
          -f frontend/Dockerfile \
          frontend

        echo "Pushing Docker image..."
        docker push $ACR_NAME.azurecr.io/$IMAGE_NAME:$IMAGE_TAG
      displayName: Build and Push Docker Image

    # Get AKS credentials
    - script: |
        set -e
        echo "Fetching AKS credentials..."
        az aks get-credentials \
          --resource-group $RESOURCE_GROUP \
          --name $AKS_CLUSTER \
          --overwrite-existing
      displayName: Configure kubectl for AKS

    # Deploy to AKS
    - script: |
        set -e

        echo "Creating namespace if missing..."
        kubectl get ns $NAMESPACE || kubectl create ns $NAMESPACE

        echo "Injecting image into manifest..."
        sed "s|PLACEHOLDER_IMAGE|$ACR_NAME.azurecr.io/$IMAGE_NAME:$IMAGE_TAG|g" k8s/deployment.yaml \
          | kubectl apply -f -

        echo "Applying service..."
        kubectl apply -f k8s/service.yaml

        echo "Deployment status:"
        kubectl rollout status deployment/frontend -n $NAMESPACE
      displayName: Deploy to AKS
