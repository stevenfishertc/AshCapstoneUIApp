trigger:
  branches:
    include:
      - main

variables:
  ACR_NAME: stevencapstoneacr
  IMAGE_NAME: frontend-app
  IMAGE_TAG: $(Build.BuildId)
  RESOURCE_GROUP: steven-rg-capstone-dev
  WEBAPP_NAME: stevens-webapp-frontend-dev

pool:
  vmImage: ubuntu-latest

stages:
- stage: BuildAndDeploy
  displayName: Build & Deploy Frontend to Azure Web App
  jobs:
  - job: BuildDeploy
    displayName: Docker → ACR → Web App
    steps:

    # Login to Azure
    - task: AzureCLI@2
      displayName: Azure Login
      inputs:
        azureSubscription: stevens-capstone-dev-conn
        scriptType: bash
        scriptLocation: inlineScript
        inlineScript: |
          az account show

    # Build and push Docker image (script-first)
    - script: |
        set -e

        echo "Logging into ACR..."
        az acr login --name $ACR_NAME

        echo "Building Docker image..."
        docker build \
          -t $ACR_NAME.azurecr.io/$IMAGE_NAME:$IMAGE_TAG \
          -f frontend/Dockerfile \
          frontend

        echo "Pushing Docker image..."
        docker push $ACR_NAME.azurecr.io/$IMAGE_NAME:$IMAGE_TAG
      displayName: Build and Push Docker Image

    # Configure Web App container
    - script: |
        set -e

        IMAGE="$ACR_NAME.azurecr.io/$IMAGE_NAME:$IMAGE_TAG"

        echo "Configuring Web App to use image: $IMAGE"

        az webapp config container set \
          --name $WEBAPP_NAME \
          --resource-group $RESOURCE_GROUP \
          --docker-custom-image-name $IMAGE \
          --docker-registry-server-url https://$ACR_NAME.azurecr.io
      displayName: Update Web App Container Image

    # Restart Web App (forces image pull)
    - script: |
        set -e

        echo "Restarting Web App..."
        az webapp restart \
          --name $WEBAPP_NAME \
          --resource-group $RESOURCE_GROUP
      displayName: Restart Web App
