trigger:
  branches:
    include:
      - main

variables:
  IMAGE_NAME: frontend-app
  IMAGE_TAG: $(Build.BuildId)

  AZURE_SUBSCRIPTION: stevens-capstone-conn

  DEV_ACR_NAME: acrcapstonedeva1b2c
  QA_ACR_NAME: acrcapstoneqaa1b2c
  PROD_ACR_NAME: acrcapstoneproda1b2c

  DEV_RESOURCE_GROUP: steven-rg-capstone-dev
  QA_RESOURCE_GROUP: steven-rg-capstone-qa
  PROD_RESOURCE_GROUP: steven-rg-capstone-prod

  DEV_WEBAPP_NAME: stevens-webapp-frontend-dev
  QA_WEBAPP_NAME: stevens-webapp-frontend-qa
  PROD_WEBAPP_NAME: stevens-webapp-frontend-prod

pool:
  vmImage: ubuntu-latest

stages:
# =========================
# BUILD + DEPLOY DEV (no env)
# =========================
- stage: Dev
  displayName: Build & Deploy to Dev Web App
  jobs:
  - job: BuildAndDeployDev
    displayName: Docker → ACR → Dev Web App
    steps:
    - task: AzureCLI@2
      displayName: Build & Push Image to ACR
      inputs:
        azureSubscription: $(AZURE_SUBSCRIPTION)
        scriptType: bash
        scriptLocation: inlineScript
        inlineScript: |
          set -e

          echo "Getting ACR access token..."
          TOKEN=$(az acr login \
            --name $(DEV_ACR_NAME) \
            --expose-token \
            --output tsv \
            --query accessToken)

          echo "Logging Docker into ACR..."
          docker login $(DEV_ACR_NAME).azurecr.io \
            -u 00000000-0000-0000-0000-000000000000 \
            -p $TOKEN

          echo "Building Docker image..."
          docker build \
            -t $(DEV_ACR_NAME).azurecr.io/$(IMAGE_NAME):$(IMAGE_TAG) \
            -f frontend/Dockerfile \
            frontend

          echo "Pushing Docker image..."
          docker push $(DEV_ACR_NAME).azurecr.io/$(IMAGE_NAME):$(IMAGE_TAG)

    - task: AzureCLI@2
      displayName: Update Dev Web App Container Image
      inputs:
        azureSubscription: $(AZURE_SUBSCRIPTION)
        scriptType: bash
        scriptLocation: inlineScript
        inlineScript: |
          set -e
          IMAGE="$(DEV_ACR_NAME).azurecr.io/$(IMAGE_NAME):$(IMAGE_TAG)"

          echo "Configuring DEV Web App to use image: $IMAGE"
          az webapp config container set \
            --name $(DEV_WEBAPP_NAME) \
            --resource-group $(DEV_RESOURCE_GROUP) \
            --container-image-name $IMAGE \
            --container-registry-url https://$(DEV_ACR_NAME).azurecr.io

    - task: AzureCLI@2
      displayName: Restart Dev Web App
      inputs:
        azureSubscription: $(AZURE_SUBSCRIPTION)
        scriptType: bash
        scriptLocation: inlineScript
        inlineScript: |
          set -e
          echo "Restarting DEV Web App..."
          az webapp restart \
            --name $(DEV_WEBAPP_NAME) \
            --resource-group $(DEV_RESOURCE_GROUP)

# =========================
# DEPLOY QA (approval via qa-env)
# =========================
- stage: QA
  displayName: Build & Deploy to QA Web App (Approval Required)
  dependsOn: Dev
  jobs:
  - deployment: DeployQA
    displayName: Build & Deploy to QA
    environment: qa-env
    strategy:
      runOnce:
        deploy:
          steps:
          - checkout: self

          - task: AzureCLI@2
            displayName: Build & Push Image to QA ACR
            inputs:
              azureSubscription: $(AZURE_SUBSCRIPTION)
              scriptType: bash
              scriptLocation: inlineScript
              inlineScript: |
                set -e

                echo "Getting QA ACR access token..."
                TOKEN=$(az acr login \
                  --name $(QA_ACR_NAME) \
                  --expose-token \
                  --output tsv \
                  --query accessToken)

                echo "Logging Docker into QA ACR..."
                docker login $(QA_ACR_NAME).azurecr.io \
                  -u 00000000-0000-0000-0000-000000000000 \
                  -p $TOKEN

                echo "Building Docker image..."
                docker build \
                  -t $(QA_ACR_NAME).azurecr.io/$(IMAGE_NAME):$(IMAGE_TAG) \
                  -f frontend/Dockerfile \
                  frontend

                echo "Pushing Docker image to QA ACR..."
                docker push $(QA_ACR_NAME).azurecr.io/$(IMAGE_NAME):$(IMAGE_TAG)

          - task: AzureCLI@2
            displayName: Update QA Web App Container Image
            inputs:
              azureSubscription: $(AZURE_SUBSCRIPTION)
              scriptType: bash
              scriptLocation: inlineScript
              inlineScript: |
                set -e
                IMAGE="$(QA_ACR_NAME).azurecr.io/$(IMAGE_NAME):$(IMAGE_TAG)"

                echo "Configuring QA Web App to use image: $IMAGE"
                az webapp config container set \
                  --name $(QA_WEBAPP_NAME) \
                  --resource-group $(QA_RESOURCE_GROUP) \
                  --container-image-name $IMAGE \
                  --container-registry-url https://$(QA_ACR_NAME).azurecr.io

          - task: AzureCLI@2
            displayName: Restart QA Web App
            inputs:
              azureSubscription: $(AZURE_SUBSCRIPTION)
              scriptType: bash
              scriptLocation: inlineScript
              inlineScript: |
                set -e
                echo "Restarting QA Web App..."
                az webapp restart \
                  --name $(QA_WEBAPP_NAME) \
                  --resource-group $(QA_RESOURCE_GROUP)

# =========================
# DEPLOY PROD (approval via producton-env)
# =========================
- stage: Prod
  displayName: Build & Deploy to Prod Web App (Approval Required)
  dependsOn: QA
  jobs:
  - deployment: DeployProd
    displayName: Build & Deploy to Prod
    environment: production-env
    strategy:
      runOnce:
        deploy:
          steps:
          - checkout: self

          - task: AzureCLI@2
            displayName: Build & Push Image to Prod ACR
            inputs:
              azureSubscription: $(AZURE_SUBSCRIPTION)
              scriptType: bash
              scriptLocation: inlineScript
              inlineScript: |
                set -e

                echo "Getting Prod ACR access token..."
                TOKEN=$(az acr login \
                  --name $(PROD_ACR_NAME) \
                  --expose-token \
                  --output tsv \
                  --query accessToken)

                echo "Logging Docker into Prod ACR..."
                docker login $(PROD_ACR_NAME).azurecr.io \
                  -u 00000000-0000-0000-0000-000000000000 \
                  -p $TOKEN

                echo "Building Docker image..."
                docker build \
                  -t $(PROD_ACR_NAME).azurecr.io/$(IMAGE_NAME):$(IMAGE_TAG) \
                  -f frontend/Dockerfile \
                  frontend

                echo "Pushing Docker image to Prod ACR..."
                docker push $(PROD_ACR_NAME).azurecr.io/$(IMAGE_NAME):$(IMAGE_TAG)

          - task: AzureCLI@2
            displayName: Update Prod Web App Container Image
            inputs:
              azureSubscription: $(AZURE_SUBSCRIPTION)
              scriptType: bash
              scriptLocation: inlineScript
              inlineScript: |
                set -e
                IMAGE="$(PROD_ACR_NAME).azurecr.io/$(IMAGE_NAME):$(IMAGE_TAG)"

                echo "Configuring PROD Web App to use image: $IMAGE"
                az webapp config container set \
                  --name $(PROD_WEBAPP_NAME) \
                  --resource-group $(PROD_RESOURCE_GROUP) \
                  --container-image-name $IMAGE \
                  --container-registry-url https://$(PROD_ACR_NAME).azurecr.io

          - task: AzureCLI@2
            displayName: Restart Prod Web App
            inputs:
              azureSubscription: $(AZURE_SUBSCRIPTION)
              scriptType: bash
              scriptLocation: inlineScript
              inlineScript: |
                set -e
                echo "Restarting PROD Web App..."
                az webapp restart \
                  --name $(PROD_WEBAPP_NAME) \
                  --resource-group $(PROD_RESOURCE_GROUP)

