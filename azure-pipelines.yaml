trigger:
  branches:
    include:
      - main

variables:
  ACR_NAME: acrcapstonedeva1b2c
  IMAGE_NAME: frontend-app
  IMAGE_TAG: $(Build.BuildId)

  DEV_SERVICE_CONN: stevens-capstone-dev-conn
  QA_SERVICE_CONN: stevens-capstone-qa-conn
  PROD_SERVICE_CONN: stevens-capstone-prod-conn

  DEV_RESOURCE_GROUP: steven-rg-capstone-dev
  QA_RESOURCE_GROUP: steven-rg-capstone-qa
  PROD_RESOURCE_GROUP: steven-rg-capstone-prod

  DEV_WEBAPP: stevens-webapp-frontend-dev
  QA_WEBAPP: stevens-webapp-frontend-qa
  PROD_WEBAPP: stevens-webapp-frontend-prod

pool:
  vmImage: ubuntu-latest

stages:

# =========================
# BUILD STAGE
# =========================
- stage: Build
  displayName: Build & Push Image
  jobs:
  - job: BuildImage
    displayName: Docker Build
    steps:

    - task: AzureCLI@2
      displayName: Build & Push Image to ACR
      inputs:
        azureSubscription: $(DEV_SERVICE_CONN)
        scriptType: bash
        scriptLocation: inlineScript
        inlineScript: |
          set -e

          echo "Getting ACR access token..."
          TOKEN=$(az acr login \
            --name $ACR_NAME \
            --expose-token \
            --output tsv \
            --query accessToken)

          docker login $ACR_NAME.azurecr.io \
            -u 00000000-0000-0000-0000-000000000000 \
            -p $TOKEN

          docker build \
            -t $ACR_NAME.azurecr.io/$IMAGE_NAME:$IMAGE_TAG \
            -f frontend/Dockerfile \
            frontend

          docker push $ACR_NAME.azurecr.io/$IMAGE_NAME:$IMAGE_TAG

# =========================
# DEV DEPLOY (AUTO)
# =========================
- stage: Dev
  displayName: Deploy to Dev
  dependsOn: Build
  jobs:
  - deployment: DeployDev
    displayName: Dev Deployment
    environment: frontend-dev
    strategy:
      runOnce:
        deploy:
          steps:
          - task: AzureCLI@2
            inputs:
              azureSubscription: $(DEV_SERVICE_CONN)
              scriptType: bash
              scriptLocation: inlineScript
              inlineScript: |
                IMAGE="$ACR_NAME.azurecr.io/$IMAGE_NAME:$IMAGE_TAG"

                az webapp config container set \
                  --name $DEV_WEBAPP \
                  --resource-group $DEV_RESOURCE_GROUP \
                  --container-image-name $IMAGE \
                  --container-registry-url https://$ACR_NAME.azurecr.io

                az webapp restart \
                  --name $DEV_WEBAPP \
                  --resource-group $DEV_RESOURCE_GROUP

# =========================
# QA DEPLOY (APPROVAL)
# =========================
- stage: QA
  displayName: Deploy to QA
  dependsOn: Dev
  jobs:
  - deployment: DeployQA
    displayName: QA Deployment
    environment: frontend-qa
    strategy:
      runOnce:
        deploy:
          steps:
          - task: AzureCLI@2
            inputs:
              azureSubscription: $(QA_SERVICE_CONN)
              scriptType: bash
              scriptLocation: inlineScript
              inlineScript: |
                IMAGE="$ACR_NAME.azurecr.io/$IMAGE_NAME:$IMAGE_TAG"

                az webapp config container set \
                  --name $QA_WEBAPP \
                  --resource-group $QA_RESOURCE_GROUP \
                  --container-image-name $IMAGE \
                  --container-registry-url https://$ACR_NAME.azurecr.io

                az webapp restart \
                  --name $QA_WEBAPP \
                  --resource-group $QA_RESOURCE_GROUP

# =========================
# PROD DEPLOY (APPROVAL)
# =========================
- stage: Prod
  displayName: Deploy to Prod
  dependsOn: QA
  jobs:
  - deployment: DeployProd
    displayName: Prod Deployment
    environment: frontend-prod
    strategy:
      runOnce:
        deploy:
          steps:
          - task: AzureCLI@2
            inputs:
              azureSubscription: $(PROD_SERVICE_CONN)
              scriptType: bash
              scriptLocation: inlineScript
              inlineScript: |
                IMAGE="$ACR_NAME.azurecr.io/$IMAGE_NAME:$IMAGE_TAG"

                az webapp config container set \
                  --name $PROD_WEBAPP \
                  --resource-group $PROD_RESOURCE_GROUP \
                  --container-image-name $IMAGE \
                  --container-registry-url https://$ACR_NAME.azurecr.io

                az webapp restart \
                  --name $PROD_WEBAPP \
                  --resource-group $PROD_RESOURCE_GROUP
